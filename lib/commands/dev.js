"use strict";var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.handler=exports.desc=exports.command=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _log=_interopRequireWildcard(require("../utils/log"));var _chalk=_interopRequireDefault(require("chalk"));var _init=require("../utils/init");var _webpack=_interopRequireDefault(require("webpack"));var _webpackDevServer=_interopRequireDefault(require("webpack-dev-server"));var _portfinder=_interopRequireDefault(require("portfinder"));var _prepareURLs=_interopRequireDefault(require("../utils/prepareURLs"));var _config=require("../config");var _extra=require("../utils/extra");var _options=_interopRequireDefault(require("../source/options"));var command="dev";exports.command=command;var desc="-- start dev ";exports.desc=desc;var handler=/*#__PURE__*/function(){var _ref=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function _callee5(){var freePort,urls;return _regenerator.default.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return(0,_log.spinner)("start webpack",/*#__PURE__*/function(){var _ref2=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function _callee3(spinner){return _regenerator.default.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:return _context3.abrupt("return",new Promise(/*#__PURE__*/function(){var _ref3=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function _callee2(resolve){var opt,devOptions,WebpackConfig,compiler,Server;return _regenerator.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:opt=Object.assign((0,_extra.getUserConfig)(),_options.default,{mode:"development"});devOptions={overlay:true,//错误展示在浏览器
hot:true,host:"0.0.0.0",//保证nginx可以代理hmr
proxy:opt.dev.proxyTable,stats:{colors:true,logLevel:"silent",chunks:false,children:false,modules:false}};WebpackConfig=(0,_config.getConfig)(opt);_webpackDevServer.default.addDevServerEntrypoints(WebpackConfig,devOptions);compiler=(0,_webpack.default)(WebpackConfig);Server=new _webpackDevServer.default(compiler,devOptions);_context2.next=8;return _portfinder.default.getPortPromise();case 8:freePort=_context2.sent;Server.listen(freePort);urls=(0,_prepareURLs.default)("http","0.0.0.0",freePort);compiler.hooks.done.tapPromise("anything",/*#__PURE__*/(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function _callee(){return _regenerator.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:spinner.clear();resolve();case 2:case"end":return _context.stop();}}},_callee,this)})));case 12:case"end":return _context2.stop();}}},_callee2,this)}));return function(_x2){return _ref3.apply(this,arguments)}}()));case 1:case"end":return _context3.stop();}}},_callee3,this)}));return function(_x){return _ref2.apply(this,arguments)}}());case 2:_context5.next=4;return(0,_log.spinner)(["app running at:"," - local:   ".concat(_chalk.default.cyan(urls.localUrlForTerminal))," - network: ".concat(_chalk.default.cyan(urls.lanUrlForTerminal))].join("\n"),/*#__PURE__*/(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function _callee4(){return _regenerator.default.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:case"end":return _context4.stop();}}},_callee4,this)})));case 4:case"end":return _context5.stop();}}},_callee5,this)}));return function handler(){return _ref.apply(this,arguments)}}();exports.handler=handler;